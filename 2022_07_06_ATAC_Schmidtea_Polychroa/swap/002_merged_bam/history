#merge samtools 1.11 Using htslib 1.11-4
samtools merge SP_1.bam ../../lib/L104869_Track-147003_csm_no_dup_mapped_q20.bam ../../lib/L104870_Track-147004_csm_no_dup_mapped_q20.bam ../../lib/L104871_Track-147005_csm_no_dup_mapped_q20.bam
samtools merge SP_2.bam ../../lib/L104872_Track-147006_csm_no_dup_mapped_q20.bam ../../lib/L104873_Track-147007_csm_no_dup_mapped_q20.bam ../../lib/L104874_Track-147008_csm_no_dup_mapped_q20.bam
samtools merge SP_3.bam ../../lib/L104875_Track-147009_csm_no_dup_mapped_q20.bam ../../lib/L104876_Track-147010_csm_no_dup_mapped_q20.bam ../../lib/L104877_Track-147011_csm_no_dup_mapped_q20.bam
samtools merge SPX_1.bam ../../lib/L109256_merged_csm_no_dup_mapped_q20.bam ../../lib/L109257_merged_csm_no_dup_mapped_q20.bam ../../lib/L109258_merged_csm_no_dup_mapped_q20.bam
samtools merge SPX_2.bam ../../lib/L109259_merged_csm_no_dup_mapped_q20.bam ../../lib/L109260_merged_csm_no_dup_mapped_q20.bam ../../lib/L109261_merged_csm_no_dup_mapped_q20.bam
samtools merge SPX_3.bam ../../lib/L109262_merged_csm_no_dup_mapped_q20.bam ../../lib/L109263_merged_csm_no_dup_mapped_q20.bam ../../lib/L109264_merged_csm_no_dup_mapped_q20.bam
samtools merge SPH_1.bam ../../lib/L109265_merged_csm_no_dup_mapped_q20.bam ../../lib/L109266_merged_csm_no_dup_mapped_q20.bam ../../lib/L109267_merged_csm_no_dup_mapped_q20.bam
samtools merge SPH_2.bam ../../lib/L109268_merged_csm_no_dup_mapped_q20.bam ../../lib/L109269_merged_csm_no_dup_mapped_q20.bam ../../lib/L109270_merged_csm_no_dup_mapped_q20.bam
samtools merge SPH_3.bam ../../lib/L109271_merged_csm_no_dup_mapped_q20.bam ../../lib/L109272_merged_csm_no_dup_mapped_q20.bam ../../lib/L109273_merged_csm_no_dup_mapped_q20.bam
samtools merge SPT_1.bam ../../lib/L109274_merged_csm_no_dup_mapped_q20.bam ../../lib/L109275_merged_csm_no_dup_mapped_q20.bam ../../lib/L109276_merged_csm_no_dup_mapped_q20.bam
samtools merge SPT_2.bam ../../lib/L109277_merged_csm_no_dup_mapped_q20.bam ../../lib/L109278_merged_csm_no_dup_mapped_q20.bam ../../lib/L109279_merged_csm_no_dup_mapped_q20.bam
samtools merge SPT_3.bam ../../lib/L109280_merged_csm_no_dup_mapped_q20.bam ../../lib/L109281_merged_csm_no_dup_mapped_q20.bam ../../lib/L109282_merged_csm_no_dup_mapped_q20.bam

#sort and index
for i in *bam; do samtools sort -@40 -o ${i%.bam}_sorted.bam $i;done
for i in *_sorted.bam; do samtools index $i;done

#create stats file
touch stats
for i in {1..9};do printf "#placeholder$i\n" >> stats; done

#stats
for i in *_sorted.bam; do printf "\n $i \n" >> stats; samtools flagstat $i >>stats; done

#extract readcounts
awk '{line[NR] = $0} /bam/ {matched[NR]} END {for (nr in matched) for (n=nr; n<=nr+9; n+=9) print line[n]}' stats | awk '{printf "%s%s",$0,(NR%2?FS:RS)}' | sed 's/  /,/' | sed "s/ //g" |  sed 's/+.*$//' > readcounts.csv

#lowest readcount
awk -F "," 'NR == 1 || $2 < min {line = $0; min = $2}END{print line}' readcounts_wt_xray.csv

awk -F "," 'NR == 1 || $2 < min {line = $0; min = $2}END{print line}' readcounts_head_tail.csv

#subsample to the lowest readcount 
#calculate factor for downsampling
awk -F ","  '$0=$0","(83155961/$2)' readcounts_wt_xray.csv
awk -F ","  '$0=$0","(111452842/$2)' readcounts_head_tail.csv

#see 003_subsampled_bam

declare -A associative
associative=([SP_1_sorted.bam]=wt1_ATAC \
[SP_2_sorted.bam]=wt2_ATAC \
[SP_3_sorted.bam]=wt3_ATAC \
[SPX_1_sorted.bam]=xray1_ATAC \
[SPX_2_sorted.bam]=xray2_ATAC \
[SPX_3_sorted.bam]=xray3_ATAC )

#create fragmentsize graph (R version 4.1.0, bioconductor-atacseqqc 1.16.0)
for i in ${!associative[@]}; do printf "library(ATACseqQC) \nbamfile <-\"$i\" \nbamfile.labels <- gsub(\"$i\", \"${associative[$i]}\", basename(bamfile)) \nfragSize <- fragSizeDist(bamfile, bamfile.labels)\n\n" > ${associative[$i]}.r && Rscript ${associative[$i]}.r && mv Rplots.pdf ${associative[$i]}_fragSizeDist.pdf; done

#remove R scripts
rm *.r
